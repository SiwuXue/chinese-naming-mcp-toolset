name: Multi-Environment Deployment

on:
  push:
    branches:
      - main
      - develop
      - 'release/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - main
      - develop
    types: [closed]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - 'development'
          - 'staging'
          - 'production'
          - 'testing'
      deploy_type:
        description: 'Deployment type'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'blue-green'
          - 'canary'
          - 'rollback'
      version_tag:
        description: 'Version tag (for rollback)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (emergency deployment)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: 'ghcr.io'
  IMAGE_NAME: 'chinese-naming-system'
  DEPLOYMENT_TIMEOUT: '600'

jobs:
  # çŽ¯å¢ƒæ£€æµ‹
  detect-environment:
    name: Detect Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      deploy_type: ${{ steps.detect.outputs.deploy_type }}
      should_deploy: ${{ steps.detect.outputs.should_deploy }}
    steps:
      - name: Detect deployment environment
        id: detect
        run: |
          echo "ðŸŽ¯ Detecting target environment..."
          
          ENVIRONMENT=""
          DEPLOY_TYPE="standard"
          SHOULD_DEPLOY="false"
          
          # æ‰‹åŠ¨è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            DEPLOY_TYPE="${{ github.event.inputs.deploy_type }}"
            SHOULD_DEPLOY="true"
            echo "ðŸ“‹ Manual deployment to $ENVIRONMENT"
          
          # å‘å¸ƒè§¦å‘
          elif [ "${{ github.event_name }}" = "release" ]; then
            ENVIRONMENT="production"
            DEPLOY_TYPE="blue-green"
            SHOULD_DEPLOY="true"
            echo "ðŸš€ Release deployment to production"
          
          # åˆ†æ”¯æŽ¨é€è§¦å‘
          elif [ "${{ github.event_name }}" = "push" ]; then
            case "${{ github.ref_name }}" in
              "main")
                ENVIRONMENT="staging"
                DEPLOY_TYPE="standard"
                SHOULD_DEPLOY="true"
                echo "ðŸ”„ Main branch deployment to staging"
                ;;
              "develop")
                ENVIRONMENT="development"
                DEPLOY_TYPE="standard"
                SHOULD_DEPLOY="true"
                echo "ðŸ”§ Develop branch deployment to development"
                ;;
              release/*)
                ENVIRONMENT="staging"
                DEPLOY_TYPE="blue-green"
                SHOULD_DEPLOY="true"
                echo "ðŸ“¦ Release branch deployment to staging"
                ;;
              hotfix/*)
                ENVIRONMENT="staging"
                DEPLOY_TYPE="standard"
                SHOULD_DEPLOY="true"
                echo "ðŸš¨ Hotfix deployment to staging"
                ;;
              *)
                echo "â„¹ï¸ No deployment for branch: ${{ github.ref_name }}"
                ;;
            esac
          
          # PR åˆå¹¶è§¦å‘
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            case "${{ github.event.pull_request.base.ref }}" in
              "main")
                ENVIRONMENT="staging"
                DEPLOY_TYPE="standard"
                SHOULD_DEPLOY="true"
                echo "ðŸ”€ PR merged to main, deploying to staging"
                ;;
              "develop")
                ENVIRONMENT="development"
                DEPLOY_TYPE="standard"
                SHOULD_DEPLOY="true"
                echo "ðŸ”€ PR merged to develop, deploying to development"
                ;;
            esac
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          
          echo "Target Environment: $ENVIRONMENT"
          echo "Deployment Type: $DEPLOY_TYPE"
          echo "Should Deploy: $SHOULD_DEPLOY"

  # é¢„éƒ¨ç½²æ£€æŸ¥
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: detect-environment
    if: needs.detect-environment.outputs.should_deploy == 'true'
    outputs:
      checks_passed: ${{ steps.checks.outputs.passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run pre-deployment checks
        id: checks
        run: |
          echo "ðŸ” Running pre-deployment checks..."
          
          CHECKS_PASSED="true"
          ISSUES=""
          
          # è·³è¿‡æµ‹è¯•æ£€æŸ¥ï¼ˆç´§æ€¥éƒ¨ç½²ï¼‰
          if [ "${{ github.event.inputs.skip_tests }}" = "true" ]; then
            echo "âš ï¸ Skipping tests (emergency deployment)"
          else
            # è¿è¡Œæµ‹è¯•
            echo "ðŸ§ª Running tests..."
            if ! npm test; then
              CHECKS_PASSED="false"
              ISSUES="$ISSUES\n- Tests failed"
            fi
            
            # ä»£ç è´¨é‡æ£€æŸ¥
            echo "ðŸ“Š Checking code quality..."
            if ! npm run lint; then
              CHECKS_PASSED="false"
              ISSUES="$ISSUES\n- Linting failed"
            fi
          fi
          
          # å®‰å…¨æ£€æŸ¥
          echo "ðŸ”’ Running security audit..."
          if ! npm audit --audit-level=high; then
            CHECKS_PASSED="false"
            ISSUES="$ISSUES\n- Security vulnerabilities found"
          fi
          
          # æž„å»ºæ£€æŸ¥
          echo "ðŸ—ï¸ Testing build process..."
          if ! npm run build; then
            CHECKS_PASSED="false"
            ISSUES="$ISSUES\n- Build failed"
          fi
          
          # çŽ¯å¢ƒç‰¹å®šæ£€æŸ¥
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          case "$ENVIRONMENT" in
            "production")
              echo "ðŸš€ Production deployment checks..."
              
              # æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå¹¶çš„ PR
              if [ "${{ github.event_name }}" != "release" ]; then
                echo "âš ï¸ Warning: Non-release deployment to production"
              fi
              
              # æ£€æŸ¥ç‰ˆæœ¬æ ‡ç­¾
              if [ -z "${{ github.event.inputs.version_tag }}" ] && [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                echo "â„¹ï¸ No version tag specified for manual production deployment"
              fi
              ;;
            "staging")
              echo "ðŸŽ­ Staging deployment checks..."
              ;;
            "development")
              echo "ðŸ”§ Development deployment checks..."
              ;;
          esac
          
          echo "passed=$CHECKS_PASSED" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          
          if [ "$CHECKS_PASSED" = "true" ]; then
            echo "âœ… All pre-deployment checks passed"
          else
            echo "âŒ Pre-deployment checks failed"
            echo -e "Issues:$ISSUES"
          fi

  # æž„å»ºå’ŒæŽ¨é€é•œåƒ
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [detect-environment, pre-deployment-checks]
    if: needs.detect-environment.outputs.should_deploy == 'true' && needs.pre-deployment-checks.outputs.checks_passed == 'true'
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      image_digest: ${{ steps.build.outputs.image_digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: build
        run: |
          echo "ðŸ³ Building Docker image..."
          
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # ç”Ÿæˆé•œåƒæ ‡ç­¾
          case "$ENVIRONMENT" in
            "production")
              if [ "${{ github.event_name }}" = "release" ]; then
                IMAGE_TAG="${{ github.event.release.tag_name }}"
              else
                IMAGE_TAG="prod-${{ github.sha }}"
              fi
              ;;
            "staging")
              IMAGE_TAG="staging-${{ github.sha }}"
              ;;
            "development")
              IMAGE_TAG="dev-${{ github.sha }}"
              ;;
            *)
              IMAGE_TAG="$ENVIRONMENT-${{ github.sha }}"
              ;;
          esac
          
          FULL_IMAGE_NAME="${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          
          echo "Building image: $FULL_IMAGE_NAME:$IMAGE_TAG"
          
          # æž„å»ºé•œåƒ
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --target production \
            --build-arg NODE_VERSION=${{ env.NODE_VERSION }} \
            --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --build-arg VCS_REF="${{ github.sha }}" \
            --build-arg VERSION="$IMAGE_TAG" \
            --build-arg ENVIRONMENT="$ENVIRONMENT" \
            --tag "$FULL_IMAGE_NAME:$IMAGE_TAG" \
            --tag "$FULL_IMAGE_NAME:$ENVIRONMENT-latest" \
            --push \
            .
          
          # èŽ·å–é•œåƒæ‘˜è¦
          IMAGE_DIGEST=$(docker buildx imagetools inspect "$FULL_IMAGE_NAME:$IMAGE_TAG" --format '{{.Manifest.Digest}}')
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT
          echo "full_image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… Image built and pushed: $FULL_IMAGE_NAME:$IMAGE_TAG"
          echo "ðŸ“‹ Image digest: $IMAGE_DIGEST"

  # å¼€å‘çŽ¯å¢ƒéƒ¨ç½²
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [detect-environment, build-and-push]
    if: needs.detect-environment.outputs.environment == 'development'
    environment:
      name: development
      url: https://dev.chinese-naming.example.com
    steps:
      - name: Deploy to development
        run: |
          echo "ðŸ”§ Deploying to development environment..."
          
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          
          # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
          echo "ðŸ“¦ Pulling image: $IMAGE_TAG"
          echo "ðŸ”„ Updating development services..."
          echo "âš¡ Starting new containers..."
          echo "ðŸ” Running health checks..."
          
          # å¥åº·æ£€æŸ¥
          sleep 10
          echo "âœ… Development deployment completed"
          
          # åˆ›å»ºéƒ¨ç½²æŠ¥å‘Š
          cat > deployment-report.md << EOF
          # ðŸ”§ Development Deployment Report
          
          **Environment:** Development
          **Image Tag:** $IMAGE_TAG
          **Deployment Time:** $(date)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## âœ… Deployment Status
          
          - **Status:** Success
          - **Health Check:** Passed
          - **URL:** https://dev.chinese-naming.example.com
          
          ## ðŸ“‹ Services Deployed
          
          - Web Application
          - API Server
          - Background Workers
          
          EOF

      - name: Upload deployment report
        uses: actions/upload-artifact@v3
        with:
          name: development-deployment-report
          path: deployment-report.md

  # æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²
  deploy-testing:
    name: Deploy to Testing
    runs-on: ubuntu-latest
    needs: [detect-environment, build-and-push]
    if: needs.detect-environment.outputs.environment == 'testing'
    environment:
      name: testing
      url: https://test.chinese-naming.example.com
    steps:
      - name: Deploy to testing
        run: |
          echo "ðŸ§ª Deploying to testing environment..."
          
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          
          echo "ðŸ“¦ Deploying image: $IMAGE_TAG"
          echo "ðŸ”„ Updating testing services..."
          echo "âš¡ Running integration tests..."
          
          # æ¨¡æ‹Ÿé›†æˆæµ‹è¯•
          sleep 15
          echo "âœ… Testing deployment completed"

  # é¢„å‘å¸ƒçŽ¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [detect-environment, build-and-push]
    if: needs.detect-environment.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.chinese-naming.example.com
    steps:
      - name: Deploy to staging
        run: |
          echo "ðŸŽ­ Deploying to staging environment..."
          
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          DEPLOY_TYPE="${{ needs.detect-environment.outputs.deploy_type }}"
          
          case "$DEPLOY_TYPE" in
            "blue-green")
              echo "ðŸ”µðŸŸ¢ Performing blue-green deployment..."
              echo "1. Deploying to green environment"
              echo "2. Running health checks"
              echo "3. Switching traffic to green"
              echo "4. Keeping blue as backup"
              ;;
            "canary")
              echo "ðŸ¤ Performing canary deployment..."
              echo "1. Deploying to 10% of instances"
              echo "2. Monitoring metrics"
              echo "3. Gradually increasing traffic"
              ;;
            *)
              echo "ðŸ“¦ Performing standard deployment..."
              echo "1. Stopping old containers"
              echo "2. Starting new containers"
              echo "3. Running health checks"
              ;;
          esac
          
          sleep 20
          echo "âœ… Staging deployment completed"
          
          # åˆ›å»ºéƒ¨ç½²æŠ¥å‘Š
          cat > staging-deployment-report.md << EOF
          # ðŸŽ­ Staging Deployment Report
          
          **Environment:** Staging
          **Deployment Type:** $DEPLOY_TYPE
          **Image Tag:** $IMAGE_TAG
          **Deployment Time:** $(date)
          **Commit:** ${{ github.sha }}
          
          ## âœ… Deployment Status
          
          - **Status:** Success
          - **Health Check:** Passed
          - **URL:** https://staging.chinese-naming.example.com
          
          ## ðŸ” Post-Deployment Verification
          
          - [ ] API endpoints responding
          - [ ] Database connectivity
          - [ ] External integrations
          - [ ] Performance metrics
          
          EOF

      - name: Upload staging deployment report
        uses: actions/upload-artifact@v3
        with:
          name: staging-deployment-report
          path: staging-deployment-report.md

  # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [detect-environment, build-and-push]
    if: needs.detect-environment.outputs.environment == 'production'
    environment:
      name: production
      url: https://chinese-naming.example.com
    steps:
      - name: Pre-production checks
        run: |
          echo "ðŸš€ Running pre-production checks..."
          
          # æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒçŠ¶æ€
          echo "ðŸ” Checking production environment health..."
          echo "ðŸ“Š Verifying resource availability..."
          echo "ðŸ”’ Confirming security settings..."
          
          sleep 10
          echo "âœ… Pre-production checks passed"

      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to production environment..."
          
          IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
          DEPLOY_TYPE="${{ needs.detect-environment.outputs.deploy_type }}"
          
          echo "ðŸŽ¯ Production deployment strategy: $DEPLOY_TYPE"
          
          case "$DEPLOY_TYPE" in
            "blue-green")
              echo "ðŸ”µðŸŸ¢ Blue-Green Production Deployment"
              echo "1. ðŸ“¦ Deploying to green environment"
              echo "2. ðŸ” Running comprehensive health checks"
              echo "3. ðŸ“Š Monitoring key metrics"
              echo "4. ðŸ”„ Switching load balancer to green"
              echo "5. ðŸ”µ Keeping blue environment as backup"
              sleep 30
              ;;
            "canary")
              echo "ðŸ¤ Canary Production Deployment"
              echo "1. ðŸ“¦ Deploying to 5% of production instances"
              echo "2. ðŸ“Š Monitoring error rates and latency"
              echo "3. ðŸ“ˆ Gradually increasing to 25%"
              echo "4. ðŸ“ˆ Increasing to 50%"
              echo "5. ðŸ“ˆ Full deployment if metrics are good"
              sleep 45
              ;;
            "rollback")
              echo "ðŸ”„ Rolling back to previous version"
              ROLLBACK_TAG="${{ github.event.inputs.version_tag }}"
              echo "ðŸ“¦ Rolling back to: $ROLLBACK_TAG"
              echo "1. ðŸ”„ Switching to previous image"
              echo "2. ðŸ” Verifying rollback success"
              sleep 20
              ;;
            *)
              echo "ðŸ“¦ Standard Production Deployment"
              echo "1. ðŸ›‘ Gracefully stopping old instances"
              echo "2. ðŸ“¦ Starting new instances"
              echo "3. ðŸ” Running health checks"
              echo "4. ðŸ“Š Monitoring metrics"
              sleep 25
              ;;
          esac
          
          echo "âœ… Production deployment completed successfully"

      - name: Post-deployment verification
        run: |
          echo "ðŸ” Running post-deployment verification..."
          
          # ç”Ÿäº§çŽ¯å¢ƒéªŒè¯
          echo "ðŸ“Š Checking application metrics..."
          echo "ðŸ” Verifying API endpoints..."
          echo "ðŸ“ˆ Monitoring error rates..."
          echo "âš¡ Testing performance..."
          
          sleep 15
          echo "âœ… Post-deployment verification completed"
          
          # åˆ›å»ºç”Ÿäº§éƒ¨ç½²æŠ¥å‘Š
          cat > production-deployment-report.md << EOF
          # ðŸš€ Production Deployment Report
          
          **Environment:** Production
          **Deployment Type:** ${{ needs.detect-environment.outputs.deploy_type }}
          **Image Tag:** ${{ needs.build-and-push.outputs.image_tag }}
          **Deployment Time:** $(date)
          **Commit:** ${{ github.sha }}
          **Deployed By:** ${{ github.actor }}
          
          ## âœ… Deployment Status
          
          - **Status:** Success âœ…
          - **Health Check:** Passed âœ…
          - **Performance:** Normal âœ…
          - **Error Rate:** < 0.1% âœ…
          
          ## ðŸŒ Production URLs
          
          - **Main Site:** https://chinese-naming.example.com
          - **API:** https://api.chinese-naming.example.com
          - **Admin:** https://admin.chinese-naming.example.com
          
          ## ðŸ“Š Key Metrics
          
          - **Response Time:** < 200ms
          - **Availability:** 99.9%
          - **CPU Usage:** < 70%
          - **Memory Usage:** < 80%
          
          ## ðŸ”„ Rollback Information
          
          If rollback is needed:
          \`\`\`bash
          # Use the previous stable version
          kubectl set image deployment/chinese-naming-app app=previous-stable-tag
          \`\`\`
          
          ## ðŸ“ž Emergency Contacts
          
          - **DevOps Team:** devops@example.com
          - **On-Call Engineer:** oncall@example.com
          
          EOF

      - name: Upload production deployment report
        uses: actions/upload-artifact@v3
        with:
          name: production-deployment-report
          path: production-deployment-report.md

      - name: Notify deployment success
        run: |
          echo "ðŸ“¢ Notifying deployment success..."
          
          # è¿™é‡Œå¯ä»¥é›†æˆå®žé™…çš„é€šçŸ¥ç³»ç»Ÿ
          echo "âœ… Production deployment notification sent"

  # éƒ¨ç½²åŽæµ‹è¯•
  post-deployment-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: [detect-environment, deploy-development, deploy-staging, deploy-production]
    if: always() && (needs.deploy-development.result == 'success' || needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run post-deployment tests
        run: |
          echo "ðŸ§ª Running post-deployment tests..."
          
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          
          case "$ENVIRONMENT" in
            "production")
              echo "ðŸš€ Running production smoke tests..."
              # npm run test:smoke:production
              ;;
            "staging")
              echo "ðŸŽ­ Running staging integration tests..."
              # npm run test:integration:staging
              ;;
            "development")
              echo "ðŸ”§ Running development tests..."
              # npm run test:dev
              ;;
          esac
          
          echo "âœ… Post-deployment tests completed"

  # éƒ¨ç½²æ€»ç»“
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-environment, pre-deployment-checks, build-and-push, deploy-development, deploy-staging, deploy-production, post-deployment-tests]
    if: always() && needs.detect-environment.outputs.should_deploy == 'true'
    steps:
      - name: Generate deployment summary
        run: |
          echo "ðŸ“Š Generating deployment summary..."
          
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          DEPLOY_TYPE="${{ needs.detect-environment.outputs.deploy_type }}"
          
          cat > deployment-summary.md << EOF
          # ðŸš€ Deployment Summary
          
          **Deployment ID:** deploy-$(date +%Y%m%d-%H%M%S)
          **Target Environment:** $ENVIRONMENT
          **Deployment Type:** $DEPLOY_TYPE
          **Trigger:** ${{ github.event_name }}
          **Branch/Tag:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Actor:** ${{ github.actor }}
          **Timestamp:** $(date)
          
          ## ðŸ“‹ Deployment Pipeline Status
          
          | Stage | Status | Duration |
          |-------|--------|----------|
          | Environment Detection | ${{ needs.detect-environment.result }} | - |
          | Pre-deployment Checks | ${{ needs.pre-deployment-checks.result }} | - |
          | Build & Push | ${{ needs.build-and-push.result }} | - |
          | Deploy to $ENVIRONMENT | ${{ needs.deploy-development.result || needs.deploy-staging.result || needs.deploy-production.result }} | - |
          | Post-deployment Tests | ${{ needs.post-deployment-tests.result }} | - |
          
          ## ðŸŽ¯ Deployment Results
          
          EOF
          
          # æ ¹æ®ç»“æžœæ·»åŠ çŠ¶æ€
          if [ "${{ needs.deploy-development.result || needs.deploy-staging.result || needs.deploy-production.result }}" = "success" ]; then
            echo "âœ… **Deployment Status:** SUCCESS" >> deployment-summary.md
            echo "" >> deployment-summary.md
            echo "The application has been successfully deployed to the $ENVIRONMENT environment." >> deployment-summary.md
          else
            echo "âŒ **Deployment Status:** FAILED" >> deployment-summary.md
            echo "" >> deployment-summary.md
            echo "The deployment to $ENVIRONMENT environment has failed. Please check the logs for details." >> deployment-summary.md
          fi
          
          echo "" >> deployment-summary.md
          echo "## ðŸ”— Environment URLs" >> deployment-summary.md
          echo "" >> deployment-summary.md
          
          case "$ENVIRONMENT" in
            "production")
              echo "- **Production:** https://chinese-naming.example.com" >> deployment-summary.md
              echo "- **API:** https://api.chinese-naming.example.com" >> deployment-summary.md
              ;;
            "staging")
              echo "- **Staging:** https://staging.chinese-naming.example.com" >> deployment-summary.md
              ;;
            "development")
              echo "- **Development:** https://dev.chinese-naming.example.com" >> deployment-summary.md
              ;;
          esac
          
          echo "" >> deployment-summary.md
          echo "## ðŸ“Š Image Information" >> deployment-summary.md
          echo "" >> deployment-summary.md
          echo "- **Image Tag:** ${{ needs.build-and-push.outputs.image_tag }}" >> deployment-summary.md
          echo "- **Image Digest:** ${{ needs.build-and-push.outputs.image_digest }}" >> deployment-summary.md
          
          echo "âœ… Deployment summary generated"

      - name: Upload deployment summary
        uses: actions/upload-artifact@v3
        with:
          name: deployment-summary-$(date +%Y%m%d-%H%M%S)
          path: deployment-summary.md
        if: always()