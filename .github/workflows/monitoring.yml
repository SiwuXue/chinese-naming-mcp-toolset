name: Monitoring & Alerts

on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
    - cron: '0 * * * *'
    # æ¯å¤©å‡Œæ™¨ç”Ÿæˆç›‘æ§æŠ¥å‘Š
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of monitoring check'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'health'
          - 'performance'
          - 'security'
          - 'dependencies'
          - 'resources'
      alert_level:
        description: 'Alert level threshold'
        required: false
        default: 'warning'
        type: choice
        options:
          - 'info'
          - 'warning'
          - 'error'
          - 'critical'

env:
  NODE_VERSION: '18'
  MONITORING_ENABLED: 'true'

jobs:
  # å¥åº·æ£€æŸ¥
  health-check:
    name: Service Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'health' || github.event.inputs.check_type == null
    outputs:
      health_status: ${{ steps.health.outputs.status }}
      response_time: ${{ steps.health.outputs.response_time }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start application for health check
        run: |
          echo "ğŸš€ Starting application for health check..."
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 30
        timeout-minutes: 2

      - name: Perform health checks
        id: health
        run: |
          echo "ğŸ¥ Performing health checks..."
          
          HEALTH_STATUS="healthy"
          RESPONSE_TIME=0
          ISSUES=""
          
          # æ£€æŸ¥åº”ç”¨æ˜¯å¦å“åº”
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "âœ… Application is responding"
            
            # æµ‹é‡å“åº”æ—¶é—´
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:3000/health)
            echo "â±ï¸ Response time: ${RESPONSE_TIME}s"
            
            # æ£€æŸ¥å“åº”æ—¶é—´é˜ˆå€¼
            if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
              HEALTH_STATUS="degraded"
              ISSUES="$ISSUES\n- Slow response time: ${RESPONSE_TIME}s"
            fi
          else
            echo "âŒ Application is not responding"
            HEALTH_STATUS="unhealthy"
            ISSUES="$ISSUES\n- Application not responding"
          fi
          
          # æ£€æŸ¥å†…å­˜ä½¿ç”¨
          MEMORY_USAGE=$(ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem -e | grep node | head -1 | awk '{print $4}' || echo "0")
          if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
            HEALTH_STATUS="degraded"
            ISSUES="$ISSUES\n- High memory usage: ${MEMORY_USAGE}%"
          fi
          
          # æ£€æŸ¥ CPU ä½¿ç”¨
          CPU_USAGE=$(ps -o pid,ppid,cmd,%mem,%cpu --sort=-%cpu -e | grep node | head -1 | awk '{print $5}' || echo "0")
          if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
            HEALTH_STATUS="degraded"
            ISSUES="$ISSUES\n- High CPU usage: ${CPU_USAGE}%"
          fi
          
          echo "status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          
          echo "Health Status: $HEALTH_STATUS"

      - name: Stop application
        run: |
          if [ -n "$APP_PID" ]; then
            kill $APP_PID || true
          fi
        if: always()

      - name: Generate health report
        run: |
          echo "# ğŸ¥ Health Check Report" > health-report.md
          echo "" >> health-report.md
          echo "**Check Time:** $(date)" >> health-report.md
          echo "**Status:** ${{ steps.health.outputs.status }}" >> health-report.md
          echo "**Response Time:** ${{ steps.health.outputs.response_time }}s" >> health-report.md
          echo "" >> health-report.md
          
          case "${{ steps.health.outputs.status }}" in
            "healthy")
              echo "âœ… **All systems operational**" >> health-report.md
              ;;
            "degraded")
              echo "âš ï¸ **Service degraded**" >> health-report.md
              echo "" >> health-report.md
              echo "### Issues Detected" >> health-report.md
              echo -e "${{ steps.health.outputs.issues }}" >> health-report.md
              ;;
            "unhealthy")
              echo "âŒ **Service unhealthy**" >> health-report.md
              echo "" >> health-report.md
              echo "### Critical Issues" >> health-report.md
              echo -e "${{ steps.health.outputs.issues }}" >> health-report.md
              ;;
          esac

      - name: Upload health report
        uses: actions/upload-artifact@v3
        with:
          name: health-report
          path: health-report.md

  # æ€§èƒ½ç›‘æ§
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == null
    outputs:
      performance_score: ${{ steps.perf.outputs.score }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install performance tools
        run: |
          npm install -g clinic
          npm install -g autocannon
          npm install -g 0x

      - name: Run performance tests
        id: perf
        run: |
          echo "âš¡ Running performance tests..."
          
          # å¯åŠ¨åº”ç”¨è¿›è¡Œæ€§èƒ½æµ‹è¯•
          npm start &
          APP_PID=$!
          sleep 30
          
          PERFORMANCE_SCORE=100
          ISSUES=""
          
          # è´Ÿè½½æµ‹è¯•
          echo "ğŸ”¥ Running load test..."
          autocannon -c 10 -d 30 http://localhost:3000 > load-test.txt || true
          
          if [ -f "load-test.txt" ]; then
            # æå–æ€§èƒ½æŒ‡æ ‡
            REQUESTS_PER_SEC=$(grep "Req/Sec" load-test.txt | awk '{print $2}' | head -1 || echo "0")
            LATENCY_AVG=$(grep "Latency" load-test.txt | awk '{print $2}' | head -1 || echo "0")
            
            echo "ğŸ“Š Requests/sec: $REQUESTS_PER_SEC"
            echo "ğŸ“Š Average latency: $LATENCY_AVG"
            
            # æ€§èƒ½è¯„åˆ†
            if (( $(echo "$REQUESTS_PER_SEC < 100" | bc -l) )); then
              PERFORMANCE_SCORE=$((PERFORMANCE_SCORE - 30))
              ISSUES="$ISSUES\n- Low throughput: $REQUESTS_PER_SEC req/sec"
            fi
            
            # æ£€æŸ¥å»¶è¿Ÿï¼ˆå‡è®¾å•ä½æ˜¯msï¼‰
            LATENCY_NUM=$(echo $LATENCY_AVG | sed 's/ms//')
            if (( $(echo "$LATENCY_NUM > 1000" | bc -l) )); then
              PERFORMANCE_SCORE=$((PERFORMANCE_SCORE - 20))
              ISSUES="$ISSUES\n- High latency: $LATENCY_AVG"
            fi
          fi
          
          # åœæ­¢åº”ç”¨
          kill $APP_PID || true
          
          echo "score=$PERFORMANCE_SCORE" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          
          echo "Performance Score: $PERFORMANCE_SCORE/100"

      - name: Generate performance report
        run: |
          echo "# âš¡ Performance Monitoring Report" > performance-report.md
          echo "" >> performance-report.md
          echo "**Test Time:** $(date)" >> performance-report.md
          echo "**Performance Score:** ${{ steps.perf.outputs.score }}/100" >> performance-report.md
          echo "" >> performance-report.md
          
          if [ -f "load-test.txt" ]; then
            echo "## ğŸ“Š Load Test Results" >> performance-report.md
            echo "" >> performance-report.md
            echo "\`\`\`" >> performance-report.md
            head -20 load-test.txt >> performance-report.md
            echo "\`\`\`" >> performance-report.md
            echo "" >> performance-report.md
          fi
          
          if [ -n "${{ steps.perf.outputs.issues }}" ]; then
            echo "## âš ï¸ Performance Issues" >> performance-report.md
            echo "" >> performance-report.md
            echo -e "${{ steps.perf.outputs.issues }}" >> performance-report.md
            echo "" >> performance-report.md
          fi
          
          echo "## ğŸ¯ Performance Targets" >> performance-report.md
          echo "" >> performance-report.md
          echo "- **Throughput:** >100 req/sec" >> performance-report.md
          echo "- **Latency:** <1000ms" >> performance-report.md
          echo "- **CPU Usage:** <80%" >> performance-report.md
          echo "- **Memory Usage:** <80%" >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: |
            performance-report.md
            load-test.txt
        if: always()

  # å®‰å…¨ç›‘æ§
  security-monitoring:
    name: Security Monitoring
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'security' || github.event.inputs.check_type == null
    outputs:
      security_score: ${{ steps.security.outputs.score }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security checks
        id: security
        run: |
          echo "ğŸ”’ Running security monitoring..."
          
          SECURITY_SCORE=100
          VULNERABILITIES=0
          ISSUES=""
          
          # npm audit
          echo "ğŸ” Running npm audit..."
          npm audit --json > audit-report.json || true
          
          if [ -f "audit-report.json" ]; then
            VULNERABILITIES=$(jq '.metadata.vulnerabilities.total // 0' audit-report.json)
            
            if [ "$VULNERABILITIES" -gt 0 ]; then
              CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
              HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
              MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-report.json)
              LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-report.json)
              
              # æ ¹æ®ä¸¥é‡ç¨‹åº¦æ‰£åˆ†
              SECURITY_SCORE=$((SECURITY_SCORE - CRITICAL * 25 - HIGH * 15 - MODERATE * 10 - LOW * 5))
              
              ISSUES="$ISSUES\n- Critical vulnerabilities: $CRITICAL"
              ISSUES="$ISSUES\n- High vulnerabilities: $HIGH"
              ISSUES="$ISSUES\n- Moderate vulnerabilities: $MODERATE"
              ISSUES="$ISSUES\n- Low vulnerabilities: $LOW"
            fi
          fi
          
          # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
          echo "ğŸ” Checking for sensitive files..."
          SENSITIVE_FILES=0
          
          # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿæ–‡ä»¶æ¨¡å¼
          for pattern in "*.key" "*.pem" "*.p12" "*.pfx" ".env" "config.json"; do
            if find . -name "$pattern" -not -path "./node_modules/*" | grep -q .; then
              SENSITIVE_FILES=$((SENSITIVE_FILES + 1))
              ISSUES="$ISSUES\n- Sensitive file pattern found: $pattern"
            fi
          done
          
          if [ "$SENSITIVE_FILES" -gt 0 ]; then
            SECURITY_SCORE=$((SECURITY_SCORE - SENSITIVE_FILES * 10))
          fi
          
          # æ£€æŸ¥ç¡¬ç¼–ç å¯†é’¥
          echo "ğŸ” Checking for hardcoded secrets..."
          SECRET_PATTERNS=0
          
          # ç®€å•çš„å¯†é’¥æ¨¡å¼æ£€æŸ¥
          if grep -r "password\s*=" src/ 2>/dev/null | grep -v "//" | grep -q .; then
            SECRET_PATTERNS=$((SECRET_PATTERNS + 1))
            ISSUES="$ISSUES\n- Potential hardcoded password found"
          fi
          
          if grep -r "api[_-]key" src/ 2>/dev/null | grep -v "//" | grep -q .; then
            SECRET_PATTERNS=$((SECRET_PATTERNS + 1))
            ISSUES="$ISSUES\n- Potential hardcoded API key found"
          fi
          
          if [ "$SECRET_PATTERNS" -gt 0 ]; then
            SECURITY_SCORE=$((SECURITY_SCORE - SECRET_PATTERNS * 15))
          fi
          
          # ç¡®ä¿åˆ†æ•°ä¸ä¸ºè´Ÿ
          if [ "$SECURITY_SCORE" -lt 0 ]; then
            SECURITY_SCORE=0
          fi
          
          echo "score=$SECURITY_SCORE" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          
          echo "Security Score: $SECURITY_SCORE/100"
          echo "Total Vulnerabilities: $VULNERABILITIES"

      - name: Generate security report
        run: |
          echo "# ğŸ”’ Security Monitoring Report" > security-report.md
          echo "" >> security-report.md
          echo "**Scan Time:** $(date)" >> security-report.md
          echo "**Security Score:** ${{ steps.security.outputs.score }}/100" >> security-report.md
          echo "**Vulnerabilities:** ${{ steps.security.outputs.vulnerabilities }}" >> security-report.md
          echo "" >> security-report.md
          
          if [ "${{ steps.security.outputs.score }}" -ge 80 ]; then
            echo "âœ… **Security status: Good**" >> security-report.md
          elif [ "${{ steps.security.outputs.score }}" -ge 60 ]; then
            echo "âš ï¸ **Security status: Needs attention**" >> security-report.md
          else
            echo "âŒ **Security status: Critical**" >> security-report.md
          fi
          
          echo "" >> security-report.md
          
          if [ -n "${{ steps.security.outputs.issues }}" ]; then
            echo "## ğŸš¨ Security Issues" >> security-report.md
            echo "" >> security-report.md
            echo -e "${{ steps.security.outputs.issues }}" >> security-report.md
            echo "" >> security-report.md
          fi
          
          if [ -f "audit-report.json" ]; then
            echo "## ğŸ“Š Vulnerability Details" >> security-report.md
            echo "" >> security-report.md
            
            # æå–æ¼æ´è¯¦æƒ…
            if [ "${{ steps.security.outputs.vulnerabilities }}" -gt 0 ]; then
              echo "### High Priority Vulnerabilities" >> security-report.md
              echo "" >> security-report.md
              
              # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„æ¼æ´ä¿¡æ¯æå–
              echo "See npm audit report for detailed vulnerability information." >> security-report.md
            else
              echo "âœ… No vulnerabilities found in dependencies." >> security-report.md
            fi
          fi
          
          echo "" >> security-report.md
          echo "## ğŸ›¡ï¸ Security Recommendations" >> security-report.md
          echo "" >> security-report.md
          echo "- Keep dependencies up to date" >> security-report.md
          echo "- Use environment variables for secrets" >> security-report.md
          echo "- Implement proper input validation" >> security-report.md
          echo "- Enable security headers" >> security-report.md
          echo "- Regular security audits" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: |
            security-report.md
            audit-report.json
        if: always()

  # èµ„æºç›‘æ§
  resource-monitoring:
    name: Resource Monitoring
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'resources' || github.event.inputs.check_type == null
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Monitor system resources
        run: |
          echo "ğŸ“Š Monitoring system resources..."
          
          # ç³»ç»Ÿä¿¡æ¯
          echo "## System Information" > resource-report.md
          echo "" >> resource-report.md
          echo "- **OS:** $(uname -s)" >> resource-report.md
          echo "- **Kernel:** $(uname -r)" >> resource-report.md
          echo "- **Architecture:** $(uname -m)" >> resource-report.md
          echo "" >> resource-report.md
          
          # CPU ä¿¡æ¯
          echo "## CPU Information" >> resource-report.md
          echo "" >> resource-report.md
          echo "- **Cores:** $(nproc)" >> resource-report.md
          echo "- **Load Average:** $(uptime | awk -F'load average:' '{print $2}')" >> resource-report.md
          echo "" >> resource-report.md
          
          # å†…å­˜ä¿¡æ¯
          echo "## Memory Information" >> resource-report.md
          echo "" >> resource-report.md
          
          TOTAL_MEM=$(free -h | awk '/^Mem:/ {print $2}')
          USED_MEM=$(free -h | awk '/^Mem:/ {print $3}')
          FREE_MEM=$(free -h | awk '/^Mem:/ {print $4}')
          
          echo "- **Total Memory:** $TOTAL_MEM" >> resource-report.md
          echo "- **Used Memory:** $USED_MEM" >> resource-report.md
          echo "- **Free Memory:** $FREE_MEM" >> resource-report.md
          echo "" >> resource-report.md
          
          # ç£ç›˜ä¿¡æ¯
          echo "## Disk Information" >> resource-report.md
          echo "" >> resource-report.md
          echo "\`\`\`" >> resource-report.md
          df -h >> resource-report.md
          echo "\`\`\`" >> resource-report.md
          echo "" >> resource-report.md
          
          # ç½‘ç»œä¿¡æ¯
          echo "## Network Information" >> resource-report.md
          echo "" >> resource-report.md
          
          # æ£€æŸ¥ç½‘ç»œè¿æ¥
          if ping -c 1 google.com > /dev/null 2>&1; then
            echo "- **Internet Connectivity:** âœ… Available" >> resource-report.md
          else
            echo "- **Internet Connectivity:** âŒ Not available" >> resource-report.md
          fi
          
          # DNS è§£ææµ‹è¯•
          if nslookup google.com > /dev/null 2>&1; then
            echo "- **DNS Resolution:** âœ… Working" >> resource-report.md
          else
            echo "- **DNS Resolution:** âŒ Failed" >> resource-report.md
          fi

      - name: Check project resources
        run: |
          echo "ğŸ“ Checking project resources..."
          
          echo "" >> resource-report.md
          echo "## Project Resources" >> resource-report.md
          echo "" >> resource-report.md
          
          # é¡¹ç›®å¤§å°
          PROJECT_SIZE=$(du -sh . | awk '{print $1}')
          echo "- **Project Size:** $PROJECT_SIZE" >> resource-report.md
          
          # node_modules å¤§å°
          if [ -d "node_modules" ]; then
            NODE_MODULES_SIZE=$(du -sh node_modules | awk '{print $1}')
            echo "- **node_modules Size:** $NODE_MODULES_SIZE" >> resource-report.md
          fi
          
          # æ–‡ä»¶ç»Ÿè®¡
          JS_FILES=$(find src -name "*.js" | wc -l)
          TEST_FILES=$(find test -name "*.js" 2>/dev/null | wc -l || echo "0")
          
          echo "- **JavaScript Files:** $JS_FILES" >> resource-report.md
          echo "- **Test Files:** $TEST_FILES" >> resource-report.md
          
          # ä»£ç è¡Œæ•°
          if [ "$JS_FILES" -gt 0 ]; then
            TOTAL_LINES=$(find src -name "*.js" -exec wc -l {} + | tail -1 | awk '{print $1}')
            echo "- **Total Lines of Code:** $TOTAL_LINES" >> resource-report.md
          fi

      - name: Upload resource report
        uses: actions/upload-artifact@v3
        with:
          name: resource-report
          path: resource-report.md

  # å‘Šè­¦å¤„ç†
  alert-handler:
    name: Alert Handler
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, security-monitoring]
    if: always()
    steps:
      - name: Evaluate alert conditions
        id: alerts
        run: |
          echo "ğŸš¨ Evaluating alert conditions..."
          
          ALERT_LEVEL="info"
          ALERTS=""
          
          # å¥åº·æ£€æŸ¥å‘Šè­¦
          HEALTH_STATUS="${{ needs.health-check.outputs.health_status }}"
          if [ "$HEALTH_STATUS" = "unhealthy" ]; then
            ALERT_LEVEL="critical"
            ALERTS="$ALERTS\nğŸš¨ CRITICAL: Service is unhealthy"
          elif [ "$HEALTH_STATUS" = "degraded" ]; then
            ALERT_LEVEL="warning"
            ALERTS="$ALERTS\nâš ï¸ WARNING: Service performance degraded"
          fi
          
          # æ€§èƒ½å‘Šè­¦
          PERF_SCORE="${{ needs.performance-monitoring.outputs.performance_score }}"
          if [ -n "$PERF_SCORE" ] && [ "$PERF_SCORE" -lt 60 ]; then
            if [ "$ALERT_LEVEL" != "critical" ]; then
              ALERT_LEVEL="warning"
            fi
            ALERTS="$ALERTS\nâš ï¸ WARNING: Low performance score: $PERF_SCORE/100"
          fi
          
          # å®‰å…¨å‘Šè­¦
          SECURITY_SCORE="${{ needs.security-monitoring.outputs.security_score }}"
          if [ -n "$SECURITY_SCORE" ] && [ "$SECURITY_SCORE" -lt 70 ]; then
            ALERT_LEVEL="critical"
            ALERTS="$ALERTS\nğŸš¨ CRITICAL: Low security score: $SECURITY_SCORE/100"
          fi
          
          echo "alert_level=$ALERT_LEVEL" >> $GITHUB_OUTPUT
          echo "alerts=$ALERTS" >> $GITHUB_OUTPUT
          
          echo "Alert Level: $ALERT_LEVEL"

      - name: Send alerts
        if: steps.alerts.outputs.alert_level != 'info'
        run: |
          echo "ğŸ“¢ Sending alerts..."
          
          # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„å‘Šè­¦ç³»ç»Ÿ
          # ä¾‹å¦‚ï¼šSlack, Discord, Email, PagerDuty ç­‰
          
          echo "Alert Level: ${{ steps.alerts.outputs.alert_level }}"
          echo -e "Alerts:${{ steps.alerts.outputs.alerts }}"
          
          # ç¤ºä¾‹ï¼šåˆ›å»º GitHub Issue
          if [ "${{ steps.alerts.outputs.alert_level }}" = "critical" ]; then
            echo "Would create critical alert issue"
          fi

      - name: Generate monitoring summary
        run: |
          echo "# ğŸ“Š Monitoring Summary" > monitoring-summary.md
          echo "" >> monitoring-summary.md
          echo "**Monitoring Time:** $(date)" >> monitoring-summary.md
          echo "**Alert Level:** ${{ steps.alerts.outputs.alert_level }}" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          echo "## ğŸ“ˆ System Status" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          echo "| Component | Status | Score |" >> monitoring-summary.md
          echo "|-----------|--------|-------|" >> monitoring-summary.md
          echo "| Health | ${{ needs.health-check.outputs.health_status }} | - |" >> monitoring-summary.md
          echo "| Performance | - | ${{ needs.performance-monitoring.outputs.performance_score }}/100 |" >> monitoring-summary.md
          echo "| Security | - | ${{ needs.security-monitoring.outputs.security_score }}/100 |" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          if [ -n "${{ steps.alerts.outputs.alerts }}" ]; then
            echo "## ğŸš¨ Active Alerts" >> monitoring-summary.md
            echo "" >> monitoring-summary.md
            echo -e "${{ steps.alerts.outputs.alerts }}" >> monitoring-summary.md
            echo "" >> monitoring-summary.md
          fi
          
          echo "## ğŸ“‹ Recommendations" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          case "${{ steps.alerts.outputs.alert_level }}" in
            "critical")
              echo "- ğŸš¨ Immediate action required" >> monitoring-summary.md
              echo "- Check service logs and restart if necessary" >> monitoring-summary.md
              echo "- Investigate security vulnerabilities" >> monitoring-summary.md
              ;;
            "warning")
              echo "- âš ï¸ Monitor closely and plan improvements" >> monitoring-summary.md
              echo "- Consider performance optimizations" >> monitoring-summary.md
              echo "- Schedule maintenance window" >> monitoring-summary.md
              ;;
            "info")
              echo "- âœ… All systems operating normally" >> monitoring-summary.md
              echo "- Continue regular monitoring" >> monitoring-summary.md
              ;;
          esac

      - name: Upload monitoring summary
        uses: actions/upload-artifact@v3
        with:
          name: monitoring-summary
          path: monitoring-summary.md
        if: always()